---
version: "3"

tasks:
  reboot_authentik:
    desc: Reboot Authentik install
    cmds:
      - kubectl delete deployment -n security authentik-server
      - kubectl delete deployment -n security authentik-worker
      - flux suspend helmrelease -n security authentik
      - flux resume helmrelease -n security authentik

  sync:
    desc: Sync flux-cluster with the Git Repository
    cmds:
      - flux reconcile source git homelab-kubernetes
      - flux reconcile kustomization cluster
    silent: false

  hr:
    desc: List all Helm Releases
    cmds:
      - flux get hr -A  | grep --colour -e "^" -e False
    silent: true

  hs:
    desc: List all Helm sources
    cmds:
      - flux get sources helm -A
    silent: true

  hc:
    desc: List all Helm charts
    cmds:
      - flux get sources chart -A
    silent: true

  k:
    desc: List all Kustomizations
    cmds:
      - flux get kustomizations -A
    silent: true

  hr-restart:
    desc: Restart all failed Helm Releases
    cmds:
      - kubectl get hr -A | grep False | awk '{printf("flretry hr %s -n %s\n", $2, $1)}'
